<!-- - gpt-4.1-mini 대신 모두 moonshotai/kimi-k2-instruct 를 사용하도록 수정
- 텍스트만 (비멀티모달) 인경우의  gpt-4.1 모델은 모두 moonshotai/kimi-k2-instruct 를 사용하도록 수정
- moonshotai/kimi-k2-instruct 이 컨텍스트 길이 설정에 문제가 생길 경우 gemini 2.5 pro 대신 gpt-4.1 로 응답하는 라우팅 로직 추가. 
- 파일 생성시에는  moonshotai/kimi-k2-instruct 모델이 걸리면 stredamObject 사용시에는 gpt-4.1로 대채하도록 수정.
- 텍스트만 (비멀티모달) grok-3 대신 모두 moonshotai/kimi-k2-instruct 로 대체하도록 수정.
- 해당 수장사항들 모두 model_logic.md에 문서 업데이트.

위 내용 적용전 코드임.
---- -->



<!-- ## Chatflix Ultimate vs Chatflix Ultimate Pro ëª¨ë¸ ì„ íƒ ë¡œì§

### ðŸŽ¯ **1ë‹¨ê³„: ì¿¼ë¦¬ ë¶„ì„**
```
Gemini 2.0 Flashë¡œ ë¶„ì„:
- Category: coding, technical, math, other
- Complexity: simple, medium, complex
- ë©€í‹°ëª¨ë‹¬ ìš”ì†Œ: ì´ë¯¸ì§€, PDF, ì½”ë“œ ì²¨ë¶€íŒŒì¼ ê°ì§€
- ì½”ë“œ ì²¨ë¶€íŒŒì¼ ê°ì§€ ì‹œ ìžë™ìœ¼ë¡œ coding ì¹´í…Œê³ ë¦¬ë¡œ ê°•ì œ ì„¤ì •
```

### ðŸŽ¯ **2ë‹¨ê³„: 1ì°¨ ëª¨ë¸ ì„ íƒ (ê¸°ì¡´ ë¡œì§)**

#### **ðŸ“ Coding ì¹´í…Œê³ ë¦¬ (ìµœìš°ì„ )**

| ì¡°ê±´ | Chatflix Ultimate | Chatflix Ultimate Pro |
|------|-------------------|----------------------|
| **ë©€í‹°ëª¨ë‹¬ + ë‹¨ìˆœ** | `gpt-4.1` | `claude-sonnet-4` |
| **ë©€í‹°ëª¨ë‹¬ + ì¤‘ê°„** | `gpt-4.1` | `gemini-2.5-pro` |
| **ë©€í‹°ëª¨ë‹¬ + ë³µìž¡** | `gemini-2.5-pro` | `gemini-2.5-pro` |
| **ë¹„ë©€í‹°ëª¨ë‹¬ + ëª¨ë“  ë³µìž¡ë„** | `gpt-4.1` | `claude-sonnet-4` (ë‹¨ìˆœ/ì¤‘ê°„), `claude-sonnet-4-thinking` (ë³µìž¡) |

#### **ðŸ–¼ï¸ ì´ë¯¸ì§€ í¬í•¨**

| ì¹´í…Œê³ ë¦¬ | ë³µìž¡ë„ | Chatflix Ultimate | Chatflix Ultimate Pro |
|----------|--------|-------------------|----------------------|
| **Technical/Math** | ëª¨ë“  ë³µìž¡ë„ | `gemini-2.5-pro` | `gemini-2.5-pro` |
| **Other** | Simple | `gemini-2.0-flash` | `gemini-2.5-flash` |
| **Other** | Medium | `gemini-2.5-flash` | `gemini-2.5-flash` |
| **Other** | Complex | `gemini-2.5-pro` | `gemini-2.5-pro` |

#### **ðŸ“„ PDF í¬í•¨**

| ë³µìž¡ë„ | Chatflix Ultimate | Chatflix Ultimate Pro |
|--------|-------------------|----------------------|
| **Simple** | `gemini-2.0-flash` | `gemini-2.5-flash` |
| **Medium** | `gemini-2.5-flash` | `gemini-2.5-flash` |
| **Complex** | `gemini-2.5-pro` | `gemini-2.5-pro` |

#### **ðŸ“ í…ìŠ¤íŠ¸ë§Œ (ë¹„ë©€í‹°ëª¨ë‹¬)**

| ì¹´í…Œê³ ë¦¬ | ë³µìž¡ë„ | Chatflix Ultimate | Chatflix Ultimate Pro |
|----------|--------|-------------------|----------------------|
| **Math** | ë‹¨ìˆœ | `grok-3` | `grok-3` |
| **Math** | ì¤‘ê°„ | `grok-3` | `grok-3-mini` |
| **Math** | ë³µìž¡ | `grok-3-mini` | `deepseek-reasoner` |
| **Technical** | ë‹¨ìˆœ | `grok-3` | `grok-3` |
| **Technical** | ì¤‘ê°„/ë³µìž¡ | `gpt-4.1` | `claude-sonnet-4` |
| **Other** | ë‹¨ìˆœ | `gpt-4.1-mini` | `gpt-4.1` |
| **Other** | ì¤‘ê°„ | `gpt-4.1-mini` | `gpt-4.1` |
| **Other** | ë³µìž¡ | `gpt-4.1` | `claude-sonnet-4` |

### ðŸŽ¯ **3ë‹¨ê³„: ê°œì„ ëœ ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ê²€ì¦ ë° ì—…ê·¸ë ˆì´ë“œ**

```typescript
// ðŸ†• ì •êµí•œ ì»¨í…ìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­ ê³„ì‚°
í˜„ìž¬_ìž…ë ¥_í† í° = estimateTokenCount(currentInput)
ížˆìŠ¤í† ë¦¬_í† í° = messages.reduce(estimateMultiModalTokens)
ì˜ˆìƒ_ì¶œë ¥_í† í° = Math.max(í˜„ìž¬_ìž…ë ¥_í† í° * 0.5, 1000)

// ðŸ†• ì²¨ë¶€íŒŒì¼ ë¬´ê±°ì›€ íŒë‹¨
isAttachmentsHeavy = hasPDF || hasCodeAttachment || 
  (hasImage && imageCount > 2) || pdfCount > 0 || codeFileCount > 1

// ðŸ†• ë™ì  ì•ˆì „ ë§ˆì§„ ì ìš©
safetyMargin = isAttachmentsHeavy ? 0.7 : 0.85  // 70% ë˜ëŠ” 85%ë§Œ ì‚¬ìš©
í•„ìš”_ì»¨í…ìŠ¤íŠ¸ = Math.ceil(ì´_í† í°_ìˆ˜ / safetyMargin)

// ðŸ†• ë©€í‹°ëª¨ë‹¬ ì½˜í…ì¸ ë³„ ì •í™•í•œ í† í° ì¶”ì •
- ì´ë¯¸ì§€: 1000 í† í°
- PDF: 5000 í† í°
- ì½”ë“œ íŒŒì¼: 3000 í† í°
- ê¸°íƒ€ íŒŒì¼: 2000 í† í°
- í…ìŠ¤íŠ¸: estimateTokenCount() ì‚¬ìš©

// 1ì°¨ ì„ íƒ ëª¨ë¸ì˜ ì»¨í…ìŠ¤íŠ¸ ìš©ëŸ‰ í™•ì¸
if (ì„ íƒëœ_ëª¨ë¸_ì»¨í…ìŠ¤íŠ¸ >= í•„ìš”_ì»¨í…ìŠ¤íŠ¸) {
  âœ… 1ì°¨ ì„ íƒ ëª¨ë¸ ì‚¬ìš©
} else {
  ðŸ”„ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
}
```

### ðŸŽ¯ **4ë‹¨ê³„: ì—…ê·¸ë ˆì´ë“œ ì‹œ ìµœì  ëª¨ë¸ ì„ íƒ + í´ë°± ë©”ì»¤ë‹ˆì¦˜**

**íš¨ìœ¨ì„± ì ìˆ˜ ê³„ì‚° (100ì  ë§Œì ):**
- **ì§€ëŠ¥ì§€ìˆ˜ (40%)**: `intelligenceIndex Ã— 0.4`
- **ì†ë„ (30%)**: `(TPS ì •ê·œí™” + ì§€ì—°ì‹œê°„ ì—­ìˆ˜) Ã— 0.3`
- **ì»¨í…ìŠ¤íŠ¸ ì—¬ìœ ë„ (20%)**: `min(ëª¨ë¸_ì»¨í…ìŠ¤íŠ¸ / í•„ìš”_ì»¨í…ìŠ¤íŠ¸, 3) Ã— 20 / 3`
- **ê¸°ëŠ¥ ë§¤ì¹­ë„ (10%)**: ë©€í‹°ëª¨ë‹¬ ì§€ì›, ì¹´í…Œê³ ë¦¬ë³„ ë³´ë„ˆìŠ¤

**ðŸš¨ ê°•í™”ëœ í´ë°± ë©”ì»¤ë‹ˆì¦˜:**
```typescript
// ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤
if (ì—…ê·¸ë ˆì´ë“œ_ì‹¤íŒ¨ || ì—ëŸ¬_ë°œìƒ || ì í•©í•œ_ëª¨ë¸_ì—†ìŒ) {
  âš¡ ë¬´ì¡°ê±´ gemini-2.5-pro-preview-05-06 ì‚¬ìš©
  ðŸ“ upgradeReason: "Fallback to gemini-2.5-pro due to [error/failure reason]"
}

// try-catchë¡œ ê°ì‹¸ì§„ ì•ˆì „í•œ ëª¨ë¸ ì„ íƒ
try {
  // ëª¨ë¸ ì„ íƒ ë¡œì§ ì‹¤í–‰
} catch (error) {
  // ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ í´ë°±
  return gemini-2.5-pro-preview-05-06
}
```

**í´ë°± ë°œìƒ ì¡°ê±´:**
1. **ì»¨í…ìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ëŠ” ëª¨ë¸ì´ ì—†ëŠ” ê²½ìš°**
2. **ëª¨ë¸ ì„ íƒ ê³¼ì •ì—ì„œ ì˜ˆì™¸/ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°**
3. **ì—…ê·¸ë ˆì´ë“œ ë¡œì§ ì‹¤í–‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí•œ ê²½ìš°**
4. **ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” API ì˜¤ë¥˜ë¡œ ëª¨ë¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš°**
5. **Agent í™œì„±í™”ëœ ëª¨ë¸ì´ ì—†ëŠ” ê²½ìš°**

**í´ë°± ìš°ì„ ìˆœìœ„:**
1. **1ìˆœìœ„**: `gemini-2.5-pro-preview-05-06` (ì•ˆì •ì„±ê³¼ ë²”ìš©ì„±ì´ ê²€ì¦ëœ ëª¨ë¸)
2. **2ìˆœìœ„**: ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ `isAgentEnabled: true` ëª¨ë¸ (ìµœí›„ì˜ ìˆ˜ë‹¨)

### ðŸ†• **ìƒì„¸ ì»¨í…ìŠ¤íŠ¸ ë¶„ì„ ì •ë³´**

**ì»¨í…ìŠ¤íŠ¸ ê³„ì‚° ê²°ê³¼ì— í¬í•¨ë˜ëŠ” ìƒì„¸ ì •ë³´:**
```typescript
contextInfo: {
  estimatedTokens: ì´_ì¶”ì •_í† í°_ìˆ˜,
  requiredContext: í•„ìš”_ì»¨í…ìŠ¤íŠ¸_í¬ê¸°,
  selectedModelContext: ì„ íƒëœ_ëª¨ë¸_ì»¨í…ìŠ¤íŠ¸,
  wasUpgraded: ì—…ê·¸ë ˆì´ë“œ_ì—¬ë¶€,
  upgradeReason?: "ì—…ê·¸ë ˆì´ë“œ_ì´ìœ ",
  breakdown: {
    currentInputTokens: í˜„ìž¬_ìž…ë ¥_í† í°,
    historyTokens: ížˆìŠ¤í† ë¦¬_í† í°,
    expectedOutputTokens: ì˜ˆìƒ_ì¶œë ¥_í† í°,
    safetyMargin: ì•ˆì „_ë§ˆì§„_ë¹„ìœ¨,
    isAttachmentsHeavy: ì²¨ë¶€íŒŒì¼_ë¬´ê±°ì›€_ì—¬ë¶€,
    attachmentDetails: {
      imageCount: ì´ë¯¸ì§€_ê°œìˆ˜,
      pdfCount: PDF_ê°œìˆ˜,
      codeFileCount: ì½”ë“œíŒŒì¼_ê°œìˆ˜,
      otherFileCount: ê¸°íƒ€íŒŒì¼_ê°œìˆ˜
    }
  }
}
```

## ðŸ” **ì£¼ìš” ì°¨ì´ì  ìš”ì•½**

| êµ¬ë¶„ | Chatflix Ultimate | Chatflix Ultimate Pro |
|------|-------------------|----------------------|
| **ì½”ë”© (ë¹„ë©€í‹°ëª¨ë‹¬)** | ëª¨ë“  ë³µìž¡ë„ `gpt-4.1` | ë‹¨ìˆœ/ì¤‘ê°„ `claude-sonnet-4`, ë³µìž¡ `claude-sonnet-4-thinking` |
| **ê¸°íƒ€ (ë¹„ë©€í‹°ëª¨ë‹¬)** | ë‹¨ìˆœ/ì¤‘ê°„ `gpt-4.1-mini`, ë³µìž¡ `gpt-4.1` | ë‹¨ìˆœ/ì¤‘ê°„ `gpt-4.1`, ë³µìž¡ `claude-sonnet-4` |
| **Math (ë¹„ë©€í‹°ëª¨ë‹¬)** | ë‹¨ìˆœ/ì¤‘ê°„ `grok-3`, ë³µìž¡ `grok-3-mini` | ë‹¨ìˆœ `grok-3`, ì¤‘ê°„ `grok-3-mini`, ë³µìž¡ `deepseek-reasoner` |
| **Technical (ë¹„ë©€í‹°ëª¨ë‹¬)** | ë‹¨ìˆœ `grok-3`, ì¤‘ê°„/ë³µìž¡ `gpt-4.1` | ë‹¨ìˆœ `grok-3`, ì¤‘ê°„/ë³µìž¡ `claude-sonnet-4` |
| **ë©€í‹°ëª¨ë‹¬ ì²˜ë¦¬** | ë” ë³´ìˆ˜ì  (Gemini ì¤‘ì‹¬) | ë” ì ê·¹ì  (Claude Sonnet 4 í™œìš©) |
| **ì»¨í…ìŠ¤íŠ¸ ê³„ì‚°** | ì •êµí•œ ë©€í‹°ëª¨ë‹¬ í† í° ì¶”ì • + ë™ì  ì•ˆì „ ë§ˆì§„ |
| **í´ë°± ë©”ì»¤ë‹ˆì¦˜** | ê°•í™”ëœ ì—ëŸ¬ ì²˜ë¦¬ + ì•ˆì „ìž¥ì¹˜ |

## ðŸ“Š **ê°œì„ ëœ ì»¨í…ìŠ¤íŠ¸ ì—…ê·¸ë ˆì´ë“œ + í´ë°± ì˜ˆì‹œ**

```text
ì˜ˆì‹œ 1: ê¸´ ì½”ë“œ ë¦¬ë·° ìš”ì²­ (ì½”ë“œ íŒŒì¼ ì²¨ë¶€)
1ì°¨ ì„ íƒ: gpt-4.1 (1M+ ì»¨í…ìŠ¤íŠ¸) - Coding ì¹´í…Œê³ ë¦¬, ë¹„ë©€í‹°ëª¨ë‹¬
ì»¨í…ìŠ¤íŠ¸ ê³„ì‚°: 
  - ìž…ë ¥: 2K í† í°
  - ížˆìŠ¤í† ë¦¬: 50K í† í°  
  - ì½”ë“œ íŒŒì¼: 3K í† í° (ì •í™•í•œ ì¶”ì •)
  - ì˜ˆìƒ ì¶œë ¥: 3K í† í° (ì½”ë“œ ìž‘ì—…ìœ¼ë¡œ ì¦ê°€)
  - ì•ˆì „ ë§ˆì§„: 0.7 (ì²¨ë¶€íŒŒì¼ ë¬´ê±°ì›€)
  - í•„ìš” ì»¨í…ìŠ¤íŠ¸: (2K + 50K + 3K + 3K) / 0.7 â‰ˆ 83K
ê²°ê³¼: ê·¸ëŒ€ë¡œ ì‚¬ìš© (1M+ >= 83K, ì¶©ë¶„í•œ ì»¨í…ìŠ¤íŠ¸)

ì˜ˆì‹œ 2: ìˆ˜í•™ ë¬¸ì œ í’€ì´ (ì¤‘ê°„ ë³µìž¡ë„)
1ì°¨ ì„ íƒ: grok-3 (131K ì»¨í…ìŠ¤íŠ¸) - Math ì¹´í…Œê³ ë¦¬, ë¹„ë©€í‹°ëª¨ë‹¬
ì»¨í…ìŠ¤íŠ¸ ê³„ì‚°:
  - ìž…ë ¥: 1K í† í°
  - ížˆìŠ¤í† ë¦¬: 20K í† í°
  - ì˜ˆìƒ ì¶œë ¥: 2K í† í° (ìˆ˜í•™ ë¬¸ì œ í’€ì´)
  - ì•ˆì „ ë§ˆì§„: 0.85 (ì²¨ë¶€íŒŒì¼ ì—†ìŒ)
  - í•„ìš” ì»¨í…ìŠ¤íŠ¸: (1K + 20K + 2K) / 0.85 â‰ˆ 27K
ê²°ê³¼: ê·¸ëŒ€ë¡œ ì‚¬ìš© (131K >= 27K, ì¶©ë¶„í•œ ì»¨í…ìŠ¤íŠ¸)

ì˜ˆì‹œ 3: ëŒ€ìš©ëŸ‰ PDF ë¶„ì„
1ì°¨ ì„ íƒ: gemini-2.0-flash (1M ì»¨í…ìŠ¤íŠ¸)
ì»¨í…ìŠ¤íŠ¸ ê³„ì‚°:
  - ìž…ë ¥: 1K í† í°
  - ížˆìŠ¤í† ë¦¬: 20K í† í°
  - PDF: 5K í† í° (ì •í™•í•œ ì¶”ì •)
  - ì˜ˆìƒ ì¶œë ¥: 2K í† í° (PDF ìž‘ì—…ìœ¼ë¡œ ì¦ê°€)
  - ì•ˆì „ ë§ˆì§„: 0.7 (PDF ë¬´ê±°ì›€)
  - í•„ìš” ì»¨í…ìŠ¤íŠ¸: (1K + 20K + 5K + 2K) / 0.7 â‰ˆ 40K
ê²°ê³¼: ê·¸ëŒ€ë¡œ ì‚¬ìš© (1M >= 40K, ì¶©ë¶„í•œ ì»¨í…ìŠ¤íŠ¸)

ì˜ˆì‹œ 4: ê·¹ëŒ€ìš©ëŸ‰ ëŒ€í™” ížˆìŠ¤í† ë¦¬
1ì°¨ ì„ íƒ: gpt-4.1 (1M+ ì»¨í…ìŠ¤íŠ¸)
ì»¨í…ìŠ¤íŠ¸ ê³„ì‚°:
  - ìž…ë ¥: 5K í† í°
  - ížˆìŠ¤í† ë¦¬: 1.2M í† í° (ë§¤ìš° ê¸´ ëŒ€í™”)
  - ì˜ˆìƒ ì¶œë ¥: 5K í† í°
  - ì•ˆì „ ë§ˆì§„: 0.85 (ì²¨ë¶€íŒŒì¼ ì—†ìŒ)
  - í•„ìš” ì»¨í…ìŠ¤íŠ¸: (5K + 1.2M + 5K) / 0.85 â‰ˆ 1.42M
ì—…ê·¸ë ˆì´ë“œ ì‹œë„: ëª¨ë“  ëª¨ë¸ì´ 1.42M ë¯¸ë§Œ
ê²°ê³¼: gemini-2.5-pro-preview-05-06 í´ë°± (ì•ˆì •ì„± ìš°ì„ )

ðŸš¨ ì˜ˆì‹œ 5: ì—ëŸ¬ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤
1ì°¨ ì„ íƒ: claude-sonnet-4
ì—ëŸ¬ ìƒí™©: ëª¨ë¸ ì •ë³´ ë¡œë”© ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)
ê²°ê³¼: gemini-2.5-pro-preview-05-06 ì¦‰ì‹œ í´ë°±
upgradeReason: "Error occurred during model selection, using fallback: gemini-2.5-pro-preview-05-06"

ðŸš¨ ì˜ˆì‹œ 6: Agent ëª¨ë¸ ì—†ìŒ ì‹œë‚˜ë¦¬ì˜¤
1ì°¨ ì„ íƒ: ì‹œë„ ì¤‘...
ë¬¸ì œ: isAgentEnabled: true ëª¨ë¸ì´ í•˜ë‚˜ë„ ì—†ìŒ
ê²°ê³¼: gemini-2.5-pro-preview-05-06 í´ë°± (í•˜ë“œì½”ë”©ëœ ì•ˆì „ìž¥ì¹˜)
upgradeReason: "No agent-enabled models available, using fallback"
``` -->